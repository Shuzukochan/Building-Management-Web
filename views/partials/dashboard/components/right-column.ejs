      <div class="right-column">
        <!-- Rooms Table -->
        <div class="rooms-table-card">
          <!-- Table Controls -->
          <div class="table-controls">
            <div class="search-filters">
              <div class="filter-group">
                <div class="search-input">
                  <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="T√¨m theo s·ªë ph√≤ng ho·∫∑c t√™n ng∆∞·ªùi ƒë·∫°i di·ªán...">
                </div>
                <div class="filter-select">
                  <select class="form-select form-select-sm" id="statusFilter">
                    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="occupied">ƒê√£ thu√™</option>
                    <option value="vacant">Tr·ªëng</option>
                    <option value="maintenance">B·∫£o tr√¨</option>
                  </select>
                </div>
                <div class="filter-select">
                  <select class="form-select form-select-sm" id="floorFilter">
                    <option value="">T·∫•t c·∫£ t·∫ßng</option>
                    <option value="1">T·∫ßng 1</option>
                    <option value="2">T·∫ßng 2</option>
                    <option value="3">T·∫ßng 3</option>
                    <option value="4">T·∫ßng 4</option>
                    <option value="5">T·∫ßng 5</option>
                    <option value="6">T·∫ßng 6</option>
                    <option value="7">T·∫ßng 7</option>
                    <option value="8">T·∫ßng 8</option>
                    <option value="9">T·∫ßng 9</option>
                  </select>
                </div>
                <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()" title="X√≥a b·ªô l·ªçc">
                  <i class="fas fa-eraser"></i>
                </button>
              </div>
              <div class="d-flex gap-2">
                <% if (currentGatewayId && currentGatewayId !== null && currentGatewayId.trim() !== '') { %>
                  <button class="btn btn-sm text-white" style="background-color: #fd7e14;" onclick="openGatewayModal()" title="Qu·∫£n l√Ω Gateway ID">
                    <i class="fas fa-network-wired"></i> Gateway ID: <%= currentGatewayId %>
                  </button>
                <% } else { %>
                  <button class="btn btn-outline-warning btn-sm" onclick="openGatewayModal()" title="Th√™m Gateway ID">
                    <i class="fas fa-plus"></i> Th√™m Gateway ID
                  </button>
                <% } %>
                <button class="btn btn-primary btn-sm" onclick="openBroadcastNotificationModal()" title="G·ª≠i th√¥ng b√°o to√†n to√† nh√†">
                  <i class="fas fa-bullhorn"></i> G·ª≠i th√¥ng b√°o
                </button>
                <button class="btn btn-success btn-sm" onclick="openAddRoomModal()" title="Th√™m ph√≤ng m·ªõi">
                  <i class="fas fa-plus"></i> Th√™m ph√≤ng
                </button>
              </div>
          </div>
        </div>

        <!-- Table Responsive Container -->
        <div class="table-responsive">
          <table class="table table-hover table-sm">
            <thead class="thead-border">
              <tr>
                    <th width="12%">Ph√≤ng</th>
                    <th width="28%">Ng∆∞·ªùi ƒë·∫°i di·ªán</th>
                    <th width="15%">Th√†nh vi√™n</th>
                    <th width="12%">Tr·∫°ng th√°i</th>
                    <th width="30%">Qu·∫£n l√Ω Nodes</th>
                    <th width="10%">H√†nh ƒë·ªông</th>
              </tr>
            </thead>
                <tbody id="roomsTableBody">
              <% if (rooms && rooms.length > 0) { %>
                <% rooms.forEach((room, index) => { %>
                      <tr class="room-row" 
                          data-room-id="<%= room.id %>"
                          data-room-number="<%= room.roomNumber %>"
                          data-phone="<%= room.phoneNumber %>"
                          data-status="<%= room.status %>"
                          data-floor="<%= room.floor %>">
                    <td>
                      <div class="room-number"><%= room.roomNumber %></div>
                      <div class="floor-info">T·∫ßng <%= room.floor %></div>
                    </td>
                    
                    <td class="text-center">
                      <div class="representative-info">
                        <% if (room.phoneNumber && room.phoneNumber.trim() !== '') { %>
                          <button type="button" 
                                  class="representative-button occupied"
                                  onclick="openManageTenantsModal('<%= room.id %>', '<%= room.roomNumber %>')"
                                  title="Qu·∫£n l√Ω danh s√°ch ng∆∞·ªùi thu√™">
                            <div class="rep-info-column">
                              <div class="rep-name">
                                <i class="fas fa-user"></i>
                                <span><%= room.tenantName || 'Ng∆∞·ªùi ƒë·∫°i di·ªán' %></span>
                              </div>
                              <div class="rep-phone">
                                <i class="fas fa-phone"></i>
                                <span><%= room.phoneNumber %></span>
                              </div>
                            </div>
                          </button>
                        <% } else { %>
                          <!-- Ki·ªÉm tra n·∫øu ph√≤ng ƒëang b·∫£o tr√¨ v√† ch∆∞a c√≥ ng∆∞·ªùi thu√™ -->
                          <% if (room.status === 'maintenance') { %>
                            <button type="button" 
                                    class="representative-button maintenance" 
                                    disabled
                                    title="Ph√≤ng ƒëang b·∫£o tr√¨">
                              <div class="maintenance-room">
                                <i class="fas fa-tools"></i>
                                <span>ƒêang b·∫£o tr√¨</span>
                              </div>
                            </button>
                          <% } else { %>
                            <button type="button" 
                                    class="representative-button vacant" 
                                    onclick="openAddTenantModal('<%= room.id %>', '<%= room.roomNumber %>')"
                                    title="Th√™m ng∆∞·ªùi thu√™">
                              <div class="empty-room">
                                <i class="fas fa-user-plus"></i>
                                <span>Th√™m ng∆∞·ªùi thu√™</span>
                              </div>
                            </button>
                          <% } %>
                        <% } %>
                      </div>
                    </td>
                    
                    <td class="text-center">
                      <% if (room.tenantCount && room.tenantCount > 0) { %>
                        <span class="member-count occupied">
                          <i class="fas fa-users"></i>
                          <%= room.tenantCount %>
                        </span>
                      <% } %>
                    </td>
                    
                    <td>
                          <% if (room.phoneNumber && room.phoneNumber.trim() !== '') { %>
                            <!-- Ph√≤ng c√≥ SƒêT = ƒê√£ thu√™, ch·ªâ c√≥ th·ªÉ chuy·ªÉn sang B·∫£o tr√¨ -->
                            <% if (room.status === 'maintenance') { %>
                      <form action="/update-room-status" method="POST" class="d-inline">
                        <input type="hidden" name="roomId" value="<%= room.id %>">
                                <select name="status" class="form-select form-select-sm status-badge status-maintenance">
                                  <option value="occupied">ƒê√£ thu√™</option>
                                  <option value="maintenance" selected>B·∫£o tr√¨</option>
                        </select>
                      </form>
                        <% } else { %>
                              <form action="/update-room-status" method="POST" class="d-inline">
                            <input type="hidden" name="roomId" value="<%= room.id %>">
                                <select name="status" class="form-select form-select-sm status-badge status-occupied">
                                  <option value="occupied" selected>ƒê√£ thu√™</option>
                                  <option value="maintenance">B·∫£o tr√¨</option>
                                </select>
                          </form>
                        <% } %>
                          <% } else { %>
                            <!-- Ph√≤ng kh√¥ng c√≥ SƒêT = Tr·ªëng, ch·ªâ c√≥ th·ªÉ chuy·ªÉn sang B·∫£o tr√¨ -->
                            <% if (room.status === 'maintenance') { %>
                              <form action="/update-room-status" method="POST" class="d-inline">
                                <input type="hidden" name="roomId" value="<%= room.id %>">
                                <select name="status" class="form-select form-select-sm status-badge status-maintenance">
                                  <option value="vacant">Tr·ªëng</option>
                                  <option value="maintenance" selected>B·∫£o tr√¨</option>
                                </select>
                              </form>
                            <% } else { %>
                              <form action="/update-room-status" method="POST" class="d-inline">
                                <input type="hidden" name="roomId" value="<%= room.id %>">
                                <select name="status" class="form-select form-select-sm status-badge status-vacant">
                                  <option value="vacant" selected>Tr·ªëng</option>
                                  <option value="maintenance">B·∫£o tr√¨</option>
                                </select>
                              </form>
                            <% } %>
                          <% } %>
                    </td>
                    
                    <td>
                          <div class="nodes-quick-actions">
                            <!-- Quick action buttons v·ªõi state th√¥ng minh -->
                            <% 
                              let hasElectricity = false;
                              let hasWater = false;
                              let electricityNodeId = null;
                              let waterNodeId = null;
                              
                              if (room.nodes && Object.keys(room.nodes).length > 0) {
                                Object.values(room.nodes).forEach(node => {
                                  if (node.type === 'electricity') {
                                    hasElectricity = true;
                                    electricityNodeId = node.id;
                                  } else if (node.type === 'water') {
                                    hasWater = true;
                                    waterNodeId = node.id;
                                  }
                                });
                              }
                            %>
                            
                            <!-- Button ƒëi·ªán -->
                            <% if (hasElectricity) { %>
                              <% 
                                // L·∫•y th√¥ng tin pin, s·ªë ƒëi·ªán v√† d√≤ng ƒëi·ªán c·ªßa node ƒëi·ªán
                                let electricityBatt = null;
                                let electricityValue = null;
                                let electricityCurrent = null;
                                if (room.nodes && room.nodes[electricityNodeId] && room.nodes[electricityNodeId].lastData) {
                                  electricityBatt = room.nodes[electricityNodeId].lastData.batt;
                                  electricityValue = room.nodes[electricityNodeId].lastData.electric;
                                  electricityCurrent = room.nodes[electricityNodeId].lastData.current;
                                }
                              %>
                              <div class="node-button-container">
                                <button type="button"
                                   class="quick-action-btn electricity has-node manage-node-btn" 
                                   data-room-id="<%= room.id %>" 
                                   data-room-number="<%= room.roomNumber %>" 
                                   data-node-id="<%= electricityNodeId %>" 
                                   data-node-type="electricity"
                                   title="Qu·∫£n l√Ω node ƒëi·ªán: <%= electricityNodeId %><%= electricityBatt !== null ? ' - Pin: ' + electricityBatt + '%' : '' %><%= electricityValue !== null ? ' - ƒêi·ªán: ' + electricityValue + ' kWh' : '' %><%= electricityCurrent !== null ? ' - D√≤ng: ' + electricityCurrent + 'A' : '' %><%= electricityCurrent !== null && electricityCurrent > 25 ? ' ‚ö†Ô∏è QU√Å D√íNG!' : '' %>">
                                  <i class="fas fa-check"></i> ƒêi·ªán<% if (electricityValue !== null) { %>: <%= electricityValue %> kWh<% } %>
                                  <% if (electricityBatt !== null) { %>
                                    <span class="node-battery-inline">
                                      <i class="fas fa-battery-<%= electricityBatt > 75 ? 'full' : electricityBatt > 50 ? 'three-quarters' : electricityBatt > 25 ? 'half' : 'quarter' %>"></i>
                                      <%= electricityBatt %>%
                                    </span>
                                  <% } %>
                                </button>
                                <span class="node-status-indicator" data-node-dev-eui="<%= electricityNodeId %>"></span>
                              </div>
                          <% } else { %>
                                <button type="button" class="quick-action-btn electricity" onclick="openAddNodeModal('<%= room.id %>', '<%= room.roomNumber %>', 'electricity')" title="Th√™m node ƒëi·ªán">
                                  <i class="fas fa-plus"></i> ƒêi·ªán
                              </button>
                          <% } %>
                              
                            <!-- Button n∆∞·ªõc -->
                            <% if (hasWater) { %>
                              <% 
                                // L·∫•y th√¥ng tin pin, s·ªë n∆∞·ªõc v√† leak c·ªßa node n∆∞·ªõc
                                let waterBatt = null;
                                let waterValue = null;
                                let waterLeak = null;
                                if (room.nodes && room.nodes[waterNodeId] && room.nodes[waterNodeId].lastData) {
                                  waterBatt = room.nodes[waterNodeId].lastData.batt;
                                  waterValue = room.nodes[waterNodeId].lastData.water;
                                  waterLeak = room.nodes[waterNodeId].lastData.leak;
                                }
                              %>
                              <div class="node-button-container">
                                <button type="button"
                                   class="quick-action-btn water has-node manage-node-btn" 
                                   data-room-id="<%= room.id %>" 
                                   data-room-number="<%= room.roomNumber %>" 
                                   data-node-id="<%= waterNodeId %>" 
                                   data-node-type="water"
                                   title="Qu·∫£n l√Ω node n∆∞·ªõc: <%= waterNodeId %><%= waterBatt !== null ? ' - Pin: ' + waterBatt + '%' : '' %><%= waterValue !== null ? ' - N∆∞·ªõc: ' + waterValue + ' m¬≥' : '' %><%= waterLeak !== null && waterLeak === 1 ? ' üíß R√í R·ªà N∆Ø·ªöC!' : '' %>">
                                  <i class="fas fa-check"></i> N∆∞·ªõc<% if (waterValue !== null) { %>: <%= waterValue %> m¬≥<% } %>
                                  <% if (waterBatt !== null) { %>
                                    <span class="node-battery-inline">
                                      <i class="fas fa-battery-<%= waterBatt > 75 ? 'full' : waterBatt > 50 ? 'three-quarters' : waterBatt > 25 ? 'half' : 'quarter' %>"></i>
                                      <%= waterBatt %>%
                                    </span>
                                  <% } %>
                                </button>
                                <span class="node-status-indicator" data-node-dev-eui="<%= waterNodeId %>"></span>
                              </div>
                            <% } else { %>
                              <button type="button" class="quick-action-btn water" onclick="openAddNodeModal('<%= room.id %>', '<%= room.roomNumber %>', 'water')" title="Th√™m node n∆∞·ªõc">
                                <i class="fas fa-plus"></i> N∆∞·ªõc
                              </button>
                            <% } %>
                            
                            <!-- Custom nodes n·∫øu c√≥ -->
                            <% if (room.nodes && Object.keys(room.nodes).length > 0) { %>
                              <% Object.values(room.nodes).forEach(node => { %>
                                <% if (node.type === 'custom') { %>
                                  <% 
                                    // L·∫•y th√¥ng tin pin v√† gi√° tr·ªã c·ªßa custom node
                                    let customBatt = null;
                                    let customValue = null;
                                    if (node.lastData) {
                                      customBatt = node.lastData.batt;
                                      customValue = node.lastData.value;
                                    }
                                  %>
                                  <div class="node-button-container">
                                    <button type="button"
                                       class="quick-action-btn custom has-node manage-node-btn" 
                                       data-room-id="<%= room.id %>" 
                                       data-room-number="<%= room.roomNumber %>" 
                                       data-node-id="<%= node.id %>" 
                                       data-node-type="custom"
                                       data-custom-name="<%= node.name && node.name !== node.id ? node.name : '' %>"
                                       title="Qu·∫£n l√Ω node: <%= node.id %><%= customBatt !== null ? ' - Pin: ' + customBatt + '%' : '' %><%= customValue !== null ? ' - Gi√° tr·ªã: ' + customValue : '' %>">
                                      <i class="fas fa-check"></i> <%= node.name || node.id %><% if (customValue !== null) { %>: <%= customValue %><% } %>
                                      <% if (customBatt !== null) { %>
                                        <span class="node-battery-inline">
                                          <i class="fas fa-battery-<%= customBatt > 75 ? 'full' : customBatt > 50 ? 'three-quarters' : customBatt > 25 ? 'half' : 'quarter' %>"></i>
                                          <%= customBatt %>%
                                        </span>
                                      <% } %>
                                    </button>
                                    <span class="node-status-indicator" data-node-dev-eui="<%= node.id %>"></span>
                                  </div>
                                <% } %>
                              <% }) %>
                            <% } %>
                            
                            <!-- Button th√™m custom -->
                            <button type="button" class="quick-action-btn custom" onclick="openAddNodeModal('<%= room.id %>', '<%= room.roomNumber %>', 'custom')" title="Th√™m node t√πy ch·ªânh">
                              <i class="fas fa-plus"></i> Custom
                            </button>
                      </div>
                    </td>
                    
                    <td>
                      <div class="action-buttons d-flex gap-1">
                        <!-- N√∫t g·ª≠i th√¥ng b√°o - ch·ªâ hi·ªÉn th·ªã n·∫øu ph√≤ng c√≥ s·ªë ƒëi·ªán tho·∫°i -->
                        <% if (room.phoneNumber && room.phoneNumber.trim() !== '') { %>
                          <button type="button" 
                                  class="btn btn-outline-primary btn-sm" 
                                  onclick="openSendNotificationModal('<%= room.id %>', '<%= room.roomNumber %>', '<%= room.phoneNumber %>')"
                                  title="G·ª≠i th√¥ng b√°o t·ªõi ph√≤ng <%= room.roomNumber %>">
                            <i class="fas fa-bell"></i>
                          </button>
                        <% } %>
                        
                        <!-- N√∫t x√≥a ph√≤ng -->
                        <button type="button" 
                                class="btn btn-outline-danger btn-sm" 
                                onclick="confirmDeleteRoom('<%= room.id %>')"
                                title="X√≥a ph√≤ng">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                    <tr id="noDataRow">
                      <td colspan="5" class="text-center text-muted py-3">
                        <i class="fas fa-inbox fa-lg mb-2"></i><br>
                        Ch∆∞a c√≥ ph√≤ng n√†o
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

