    // ==================== BROADCAST NOTIFICATION FUNCTIONS ====================
    
    // Open broadcast notification modal
    function openBroadcastNotificationModal() {
      try {
        // Reset form with default values
        document.getElementById('broadcastTarget').value = 'all_residents';
        document.getElementById('broadcastTitle').value = 'Qu·∫£n l√≠ to√† nh√†';
        document.getElementById('broadcastMessage').value = '';
        
        // Update info display
        updateBroadcastInfo();
        
        // Show modal
        new bootstrap.Modal(document.getElementById('broadcastNotificationModal')).show();
        
      } catch (error) {
        console.error('Error opening broadcast notification modal:', error);
        alert('L·ªói khi m·ªü modal g·ª≠i th√¥ng b√°o: ' + error.message);
      }
    }
    
    // Update broadcast target info
    function updateBroadcastInfo() {
      const target = document.getElementById('broadcastTarget').value;
      const infoElement = document.getElementById('broadcastTargetInfo');
      
      const targetNames = {
        'all_residents': 'To√†n to√† nh√†',
        'floor_1': 'T·∫ßng 1',
        'floor_2': 'T·∫ßng 2', 
        'floor_3': 'T·∫ßng 3',
        'floor_4': 'T·∫ßng 4',
        'floor_5': 'T·∫ßng 5',
        'floor_6': 'T·∫ßng 6',
        'floor_7': 'T·∫ßng 7',
        'floor_8': 'T·∫ßng 8',
        'floor_9': 'T·∫ßng 9'
      };
      
      infoElement.textContent = targetNames[target] || target;
    }
    
    // Send broadcast notification
    async function sendBroadcastNotification() {
      try {
        const target = document.getElementById('broadcastTarget').value;
        const title = document.getElementById('broadcastTitle').value.trim();
        const message = document.getElementById('broadcastMessage').value.trim();
        
        // Validation
        if (!title) {
          alert('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ th√¥ng b√°o');
          return;
        }
        
        if (!message) {
          alert('Vui l√≤ng nh·∫≠p n·ªôi dung th√¥ng b√°o');
          return;
        }
        
        if (message.length > 500) {
          alert('N·ªôi dung th√¥ng b√°o kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 500 k√Ω t·ª±');
          return;
        }
        
        // Disable button while sending
        const sendButton = document.querySelector('#broadcastNotificationModal .btn-primary');
        const originalText = sendButton.innerHTML;
        sendButton.disabled = true;
        sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang g·ª≠i...';
        
        // Send FCM topic notification via API
        console.log('üì¢ Sending broadcast notification:', {
          target: target,
          title,
          message
        });
        
        // Call FCM Topic API - Controller s·∫Ω t·ª± ƒë·ªông s·ª≠ d·ª•ng building ID hi·ªán t·∫°i cho topic
        const response = await fetch('/api/send-topic-notification', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            target: target, // Ch·ªâ g·ª≠i target ƒë·ªÉ controller bi·∫øt ph·∫°m vi, kh√¥ng ph·∫£i topic c·ª• th·ªÉ
            title,
            message
          })
        });
        
        // Check for authentication error
        if (response.status === 401) {
          alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
          window.location.href = '/';
          return;
        }
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error);
        }
        
        // Show success message
        const targetNames = {
          'all_residents': 'to√†n to√† nh√†',
          'floor_1': 't·∫ßng 1',
          'floor_2': 't·∫ßng 2', 
          'floor_3': 't·∫ßng 3',
          'floor_4': 't·∫ßng 4',
          'floor_5': 't·∫ßng 5',
          'floor_6': 't·∫ßng 6',
          'floor_7': 't·∫ßng 7',
          'floor_8': 't·∫ßng 8',
          'floor_9': 't·∫ßng 9'
        };
        
        toastManager.success(`ƒê√£ g·ª≠i th√¥ng b√°o t·ªõi ${targetNames[target] || target}`);
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('broadcastNotificationModal'));
        modal.hide();
        
        // Reset button
        sendButton.disabled = false;
        sendButton.innerHTML = originalText;
        
      } catch (error) {
        console.error('Error sending broadcast notification:', error);
        
        // Reset button
        const sendButton = document.querySelector('#broadcastNotificationModal .btn-primary');
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> G·ª≠i th√¥ng b√°o';
        
        alert('L·ªói khi g·ª≠i th√¥ng b√°o: ' + error.message);
      }
    }

